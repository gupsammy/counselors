import { describe, expect, it } from 'vitest';
import { execute } from '../../src/core/executor.js';

describe('execute', () => {
  it('captures stdout', async () => {
    const result = await execute(
      {
        cmd: 'echo',
        args: ['hello world'],
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.exitCode).toBe(0);
    expect(result.stdout.trim()).toBe('hello world');
    expect(result.timedOut).toBe(false);
  });

  it('captures stderr', async () => {
    const result = await execute(
      {
        cmd: 'node',
        args: ['-e', 'console.error("oops")'],
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.stderr.trim()).toBe('oops');
  });

  it('handles non-zero exit codes', async () => {
    const result = await execute(
      {
        cmd: 'node',
        args: ['-e', 'process.exit(42)'],
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.exitCode).toBe(42);
  });

  it('times out and kills', async () => {
    const result = await execute(
      {
        cmd: 'sleep',
        args: ['60'],
        cwd: process.cwd(),
      },
      500,
    );

    expect(result.timedOut).toBe(true);
  });

  it('handles stdin', async () => {
    const result = await execute(
      {
        cmd: 'node',
        args: [
          '-e',
          'let d="";process.stdin.on("data",c=>d+=c);process.stdin.on("end",()=>process.stdout.write(d))',
        ],
        stdin: 'hello from stdin',
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.stdout).toBe('hello from stdin');
  });

  it('handles missing binary', async () => {
    const result = await execute(
      {
        cmd: 'nonexistent-binary-xyz',
        args: [],
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.exitCode).toBe(1);
    expect(result.stderr).toContain('ENOENT');
  });

  it('strips ANSI codes from output', async () => {
    const result = await execute(
      {
        cmd: 'node',
        args: ['-e', 'process.stdout.write("\\x1b[31mred\\x1b[0m")'],
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.stdout).toBe('red');
  });

  it('does not leak SECRET_KEY or other non-allowlisted env vars', async () => {
    // Set a secret in current process env
    process.env.SECRET_KEY = 'super-secret-value';
    try {
      const result = await execute(
        {
          cmd: 'node',
          args: [
            '-e',
            'process.stdout.write(process.env.SECRET_KEY || "NOT_SET")',
          ],
          cwd: process.cwd(),
        },
        5000,
      );

      expect(result.stdout).toBe('NOT_SET');
    } finally {
      delete process.env.SECRET_KEY;
    }
  });

  it('passes allowlisted env vars (HOME)', async () => {
    const result = await execute(
      {
        cmd: 'node',
        args: ['-e', 'process.stdout.write(process.env.HOME || "MISSING")'],
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.stdout).not.toBe('MISSING');
    expect(result.stdout).toBeTruthy();
  });

  it('merges invocation.env into child env', async () => {
    const result = await execute(
      {
        cmd: 'node',
        args: [
          '-e',
          'process.stdout.write(process.env.MY_TOOL_VAR || "MISSING")',
        ],
        env: { MY_TOOL_VAR: 'tool-specific' },
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.stdout).toBe('tool-specific');
  });

  it('passes API key env vars through to child processes', async () => {
    process.env.ANTHROPIC_API_KEY = 'test-anthropic-key';
    process.env.OPENAI_API_KEY = 'test-openai-key';
    process.env.GEMINI_API_KEY = 'test-gemini-key';
    try {
      const result = await execute(
        {
          cmd: 'node',
          args: [
            '-e',
            'process.stdout.write([process.env.ANTHROPIC_API_KEY, process.env.OPENAI_API_KEY, process.env.GEMINI_API_KEY].join(","))',
          ],
          cwd: process.cwd(),
        },
        5000,
      );

      expect(result.stdout).toBe(
        'test-anthropic-key,test-openai-key,test-gemini-key',
      );
    } finally {
      delete process.env.ANTHROPIC_API_KEY;
      delete process.env.OPENAI_API_KEY;
      delete process.env.GEMINI_API_KEY;
    }
  });

  it('passes NVM_BIN through to child processes', async () => {
    process.env.NVM_BIN = '/fake/nvm/bin';
    try {
      const result = await execute(
        {
          cmd: 'node',
          args: [
            '-e',
            'process.stdout.write(process.env.NVM_BIN || "NOT_SET")',
          ],
          cwd: process.cwd(),
        },
        5000,
      );

      expect(result.stdout).toBe('/fake/nvm/bin');
    } finally {
      delete process.env.NVM_BIN;
    }
  });

  it('passes proxy env vars through to child processes', async () => {
    process.env.HTTP_PROXY = 'http://proxy:8080';
    process.env.HTTPS_PROXY = 'https://proxy:8443';
    process.env.NO_PROXY = 'localhost';
    try {
      const result = await execute(
        {
          cmd: 'node',
          args: [
            '-e',
            'process.stdout.write([process.env.HTTP_PROXY, process.env.HTTPS_PROXY, process.env.NO_PROXY].join(","))',
          ],
          cwd: process.cwd(),
        },
        5000,
      );

      expect(result.stdout).toBe(
        'http://proxy:8080,https://proxy:8443,localhost',
      );
    } finally {
      delete process.env.HTTP_PROXY;
      delete process.env.HTTPS_PROXY;
      delete process.env.NO_PROXY;
    }
  });

  it('passes NODE_OPTIONS through to child processes', async () => {
    process.env.NODE_OPTIONS = '--max-old-space-size=4096';
    try {
      const result = await execute(
        {
          cmd: 'node',
          args: [
            '-e',
            'process.stdout.write(process.env.NODE_OPTIONS || "NOT_SET")',
          ],
          cwd: process.cwd(),
        },
        5000,
      );

      expect(result.stdout).toBe('--max-old-space-size=4096');
    } finally {
      delete process.env.NODE_OPTIONS;
    }
  });

  it('always sets CI=true and NO_COLOR=1', async () => {
    const result = await execute(
      {
        cmd: 'node',
        args: [
          '-e',
          'process.stdout.write(`${process.env.CI}:${process.env.NO_COLOR}`)',
        ],
        cwd: process.cwd(),
      },
      5000,
    );

    expect(result.stdout).toBe('true:1');
  });

  it('truncates stdout exceeding 10MB', async () => {
    // Generate ~11MB of output
    const result = await execute(
      {
        cmd: 'node',
        args: [
          '-e',
          `
        const chunk = 'x'.repeat(1024 * 1024); // 1MB
        for (let i = 0; i < 11; i++) process.stdout.write(chunk);
      `,
        ],
        cwd: process.cwd(),
      },
      15000,
    );

    // Should be capped near 10MB + truncation marker
    expect(result.stdout.length).toBeLessThan(11 * 1024 * 1024);
    expect(result.stdout).toContain('[output truncated at 10MB]');
  });
});
